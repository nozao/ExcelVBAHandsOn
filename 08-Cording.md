# 08-プログラムを作成する

ここまででプログラムを作成するために必要な最低限の知識が身につきましたので早速作成してみましょう。  

## プログラムを作成するための基本的な考え方

プログラムを作成する場合の基本的な考え方を紹介します。  
とはいえ、これが正解というものがあるわけではありませんし、作成するプログラムの規模や人数によっても変わってきます。  

今回紹介するものはひとつの例として参考にしてください。  


### 完成時のイメージを確認する

まず作成したいものはどういったものなのか、見た目や処理をざっくり確認します。  

これは手書きの図やExcel/Powerpointなどで作った図などでも構いません。イメージを固めるために一度整理しておきましょう。  

この段階で可能であれば使ってみた場合の操作感を想像して、不足している機能などがあれば追加しておきます。

今回はこのような万年カレンダーを作ります。

![](images/08-Cording/08-Cording20222103-153654.png)  


実際のところ、万年カレンダーはマクロでなくてもExcel関数と書式設定だけで作成できてしまうのですが、それを言ってしまうとマクロの授業になりませんので今回はあえてマクロで作成します。  


### データの流れや入力/出力を整理する

イメージがざっくり掴めたら、このマクロのデータの入力と出力を確認します。  

言い方を変えると「何の情報をもとに動作して」「どういうことをするのか」を整理するということです。

今回は下図のように  
`C1セルとD1セルに入力された年・月をもとにして`  
`A3セルからG8セルまでの間にカレンダーを書く`  
マクロになります。
![](images/08-Cording/08-Cording20222103-154054.png)

### 自分が(人が)手作業でやる場合にはどうするのかを考える

いろいろやり方が考えられると思いますが、今回はこのように考えました。

1. C1,D1に書かれた値を元に、カレンダーを表示する月の初日(1日)を決定する
2. 1で求めた日が含まれる週の日曜日は何月何日なのかを調べる
3. A3セルからG8セルまで1日づつ増やして日付を入力する
![](images/08-Cording/08-Cording20222103-155927.png)

この作業のコツは、なるべく作業を細分化することです。  
もっと大きな作業で区切ってしまうと、後の工程でマクロを書こうとしたときに「どうやってやるの・・・？」と詰まったり、そのやり方では出来ないという事に気づいてやり直しになってしまったりします。  

もちろん、慣れてくれば大きな作業で区切っても構いませんが、最初は細かく具体的な作業単位で区切るようにしましょう。

### 実際に書く(1)

本来はもっと細かな設計が必要な場合も多いですが、今回くらいの小規模のマクロであればもう書き始めて良いと思います。  


まずは、マクロの大枠を書きます。

```vb
Sub main()

End Sub
```

この状態では「何もしないマクロ」になっています。  
ここに、まずは先程考えた作業単位をメモとして記入します。  
```vb
Sub main()

    'C1,D1に書かれた値を元に、カレンダーを表示する月の初日(1日)を決定する

    '1で求めた日が含まれる週の日曜日は何月何日なのかを調べる

    'A3からG8セルまで1日づつ増やして日付を入力する

End Sub
```
行の先頭をシングルクォーテーション`'`で開始すると、その行はプログラムではない扱いになりますので、好きな言葉を入力できます。
これを`コメント`と呼びます。  

シングルクォーテーションは`Shift + 7`キーで入力できます。  

### 実際に書く(2)
コメントの下にそれぞれコメントに沿ったプログラムを作成していきます。  
まずはこれを作ります。  

```vb
    'C1,D1に書かれた値を元に、カレンダーを表示する月を決定する
```
年と月の値は入力値として与えられているので、これを元に特定の日を求めます。  
googleで`VBA 年月日`と検索するとこのようなものが見つかりましたので、これが使えそうです。
![](images/08-Cording/08-Cording20222103-163551.png)

調べてみると、年、月、日を元にして日付型の値を求めてくれる命令でした。今回の目的にぴったりあっているのでこれを使います。  

使い方は
`DateSerial(年,月,日)`とすれば良いようです。  
これで求めたい日は月の初日(1日)なので日は1、年と月はそれぞれC1セル、D1セルの値をそのまま持ってきます。

出来上がった結果は変数に格納します。今回はFirstDateという変数名にしました。  

C1セルの値はCells(1,3).Value  
D1セルの値はCells(1,4).Value  
で取得することが出来ます。(7章参照)

```vb
    'C1,D1に書かれた値を元に、カレンダーを表示する月を決定する
    FirstDate = DateSerial(Cells(1, 3).Value, Cells(1, 4).Value, 1)
```
### 実際に書く(3)

次の行に進みます。

```vb
    '1で求めた日が含まれる週の日曜日は何月何日なのかを調べる
```

ここでやろうとしていることを念の為詳しく説明します。  
例えば2022/4/1の場合、下図緑枠が2022/4/1が含まれる週になります。  
その週の日曜日というと、赤枠の`2022/3/27`となります。  
これを求めようとしています。  
![](images/08-Cording/08-Cording20222103-165545.png)  

なぜこのような事をしているかというと、月によって初日(1日)は何曜日から始まるかがバラバラであるため、指定月の1日が開始するセルはA3セルからG3セルのどこかになります。  
対策としては

1. 指定月の1日が始まるセルを計算して、そこから書き始める
2. 必ずA3セルから書き始めることにして、A3セルが何月何日なのかを求める  

の2つがあると思いますが、今回は2を採用しました。  

ということで、`指定した日が含まれる週の指定曜日が何月何日かを調べる`必要があります。

またgoogle先生に聞いてみます。  
`VBA 週 曜日`で検索するとこのようなものが見つかりました。
![](images/08-Cording/08-Cording20222103-164552.png)

調べてみると、`Weekday`という命令を使うと、指定した日がその週で何日目なのかを返してくれるようです。  

これをうまく使えば`指定月の1日が含まれる週の日曜日`を求めることができそうです。
![](images/08-Cording/08-Cording20222103-172646.png)

WeekDayの使い方は`WeekDay(指定日,週の基準曜日)`とすれば良いようです。  

`週の基準曜日`は下表に従って指定します。  
| 定数        | 値 | 説明                           |
| ----------- | -- | ------------------------------ |
| vbUseSystem | 0  | システムの設定値を使用します。 |
| vbSunday    | 1  | (既定値) 日曜                  |
| vbMonday    | 2  | 月曜                           |
| vbTuesday   | 3  | 火曜                           |
| vbWednesday | 4  | 水曜                           |
| vbThursday  | 5  | 木曜                           |
| vbFriday    | 6  | 金曜                           |
| vbSaturday  | 7  | 土曜                           |

今回は日曜始まりで計算したいので、vbSundayを指定します。  
結果を受け取る変数は`DiffDay`としました。  
指定日は前の行で求めたFirstDateに格納されているはずです。  

```vb
    '1で求めた日が含まれる週の日曜日は何月何日なのかを調べる
    DiffDay = Weekday(FirstDate, vbSunday)
```
